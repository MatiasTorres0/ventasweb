{% extends 'core/base.html' %}
{% load static %}

{% block contenido %}
  <h2>Carrito de Ventas</h2>
  <ul>
    {% for producto in carrito_productos %}
      <li>{{ producto.nombre }} - Precio: {{ producto.precio }}</li>
    {% endfor %}
  </ul>
  <p>Total a Pagar: $<span id="totalAmount">{{ totalAmount }}</span></p>

  <form method="post" action="{% url 'realizar_pago' %}">
    {% csrf_token %}
    
    <label for="metodoPago">Método de Pago:</label>
    <select id="metodoPago" name="metodoPago">
      <option value="efectivo">Efectivo</option>
      <option value="tarjeta_credito">Tarjeta de Crédito</option>
      <option value="tarjeta_debito">Tarjeta de Débito</option>
      <option value="prepago">Prepago</option>
    </select>
    <br>
    <label for="montoPagado">Monto Pagado:</label>
    <input type="number" id="montoPagado" name="montoPagado" min="0" step="0.01">
    <br>
    <label for="vuelto">Vuelto:</label>
    <input type="number" id="vuelto" name="vuelto" disabled>
    <br>
    <label for="ivaPagado">IVA Pagado:</label>
    <input type="number" id="ivaPagado" name="ivaPagado" disabled>
    <br>
    <button type="submit">Realizar Pago</button>
  </form>
  <script>
    // Resto del código JavaScript (sin cambios)...
    // ...
    function actualizarIVAyVuelto() {
        const montoPagado = parseFloat(document.getElementById("montoPagado").value);
        const ivaPagado = totalAmount * 0.19;
        const vuelto = montoPagado - totalAmount;

        document.getElementById("ivaPagado").value = ivaPagado.toFixed(2);
        document.getElementById("vuelto").value = vuelto.toFixed(2);
    }
    // Resto del código JavaScript (sin cambios)...
    // ...
</script>
  <script>
    // Resto del código JavaScript (sin cambios)...
    // ...
    const codigosDescuento = {
      "DESC10": 0.1, // 10% de descuento
      "DESC20": 0.2, // 20% de descuento
      // Puedes agregar más códigos de descuento aquí.
    };

    function aplicarDescuento() {
      const discountCode = document.getElementById("discountCode").value;
      const discountPercentage = codigosDescuento[discountCode];

      if (discountPercentage) {
        // Aplicar descuento a los productos en la lista de compra.
        shoppingCart.forEach(product => {
          product.descuentoAdicional = discountPercentage; // Agregar un nuevo campo 'descuentoAdicional' a los productos.
        });

        // Actualizar la lista de compra para reflejar los descuentos aplicados.
        actualizarListaCompra();

        // Limpiar el campo de entrada del código de descuento.
        document.getElementById("discountCode").value = "";

        alert(`¡Descuento aplicado!`);
      } else {
        alert("Código de descuento inválido.");
      }
    }
    function pagar() {
      // Mostrar el formulario de método de pago
      const metodoPagoContainer = document.getElementById("metodoPagoContainer");
      metodoPagoContainer.style.display = "block";

      // Obtener el método de pago seleccionado
      const metodoPago = document.getElementById("metodoPago").value;

      // Obtener el monto pagado por el cliente
      const montoPagado = parseFloat(document.getElementById("montoPagado").value);

      // Calcular el vuelto y el IVA pagado
      const vuelto = montoPagado - totalAmount;
      const ivaPagado = totalAmount * 0.19;

      // Mostrar el vuelto y el IVA pagado
      document.getElementById("vuelto").value = vuelto.toFixed(2);
      document.getElementById("ivaPagado").value = ivaPagado.toFixed(2);

      // Aquí podrías implementar la lógica para procesar el pago y guardar la venta en la base de datos.
      alert(`Total a Pagar: $${totalAmount.toFixed(2)}\nMétodo de Pago: ${metodoPago}\nMonto Pagado: $${montoPagado.toFixed(2)}\nVuelto: $${vuelto.toFixed(2)}\nIVA Pagado: $${ivaPagado.toFixed(2)}\n¡Gracias por su compra!`);

      shoppingCart = [];
      actualizarListaCompra();
    }
  </script>
  <script>

    function buscarProductos() {
      const searchTerm = document.getElementById("productSearch").value.toLowerCase();

      // Realizar la solicitud AJAX a la URL de Django
      fetch(`/buscar-producto-ajax/?search_input=${searchTerm}`)
        .then(response => response.json())
        .then(data => mostrarResultados(data))
        .catch(error => console.error("Error en la solicitud AJAX:", error));
    }



    function agregarProductoPorNombre(event) {
      const productId = event.target.getAttribute("data-product-id");
      const selectedProduct = products.find(product => product.id === productId);
      agregarProducto(selectedProduct);
    }



    function actualizarListaCompra() {
  const shoppingList = document.getElementById("shoppingList");
  shoppingList.innerHTML = "";

  totalAmount = 0.00;
  shoppingCart.forEach((product, index) => {
    const listItem = document.createElement("li");
    const productPrice = parseFloat(product.precio); // Convert to a number
    if (!isNaN(productPrice)) { // Check if the conversion was successful
      console.log(`Product Price for ${product.nombre}: ${productPrice}`);
      const discount = product.descuento || 0; // Use 0 as the default discount if it's not provided
      listItem.textContent = `${product.nombre} - Precio: $${productPrice.toFixed(2)}`;
      const deleteButton = document.createElement("button");
      deleteButton.textContent = "Eliminar";
      deleteButton.addEventListener("click", () => eliminarProducto(index));
      listItem.appendChild(deleteButton);
      shoppingList.appendChild(listItem);

      totalAmount += productPrice * (1 - discount / 100);
    } else {
      console.error(`Invalid price for product '${product.nombre}'`);
    }
  });

  console.log(`Total Amount: ${totalAmount}`);

  document.getElementById("totalAmount").textContent = totalAmount.toFixed(2);
}

function pagar() {
// Mostrar el formulario de método de pago
const metodoPagoContainer = document.getElementById("metodoPagoContainer");
metodoPagoContainer.style.display = "block";

// Deshabilitar el botón de "Pagar" para evitar pagos múltiples antes de elegir el método de pago.
const pagarButton = document.getElementById("pagarButton");
pagarButton.disabled = true;

// Deshabilitar el campo de monto pagado por defecto, ya que el cliente aún no ha ingresado el monto.
const montoPagadoInput = document.getElementById("montoPagado");
montoPagadoInput.disabled = true;

// Obtener el método de pago seleccionado
const metodoPago = document.getElementById("metodoPago").value;

if (metodoPago !== "efectivo") {
  // Si el método de pago no es 'efectivo', autocompletar el campo de monto pagado con el total a pagar
  montoPagadoInput.value = totalAmount.toFixed(2);
} else {
  // Si el método de pago es 'efectivo', permitir que el cliente ingrese el monto
  montoPagadoInput.value = ""; // Limpiar el campo
  montoPagadoInput.disabled = false; // Habilitar el campo para ingresar el monto
}

// Hacer una solicitud al servidor
const formData = new FormData(document.getElementById("formPagar"));
fetch("/pagar", {
  method: "post",
  body: formData
}).then(response => {
  if (response.ok) {
    response.json().then(data => {
      // Actualizar los campos del formulario con los datos devueltos por el servidor
      document.getElementById("vuelto").value = data.vuelto;
      document.getElementById("ivaPagado").value = data.ivaPagado;
    });
  } else {
    alert("Hubo un error al procesar su pago.");
  }
});
}

function actualizarListaCompra() {
    // ...
    shoppingCart.forEach((product, index) => {
        const listItem = document.createElement("li");
        // ...
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Eliminar";
        deleteButton.addEventListener("click", () => eliminarProducto(index)); // Llamar a la función eliminarProducto con el índice correcto
        listItem.appendChild(deleteButton);
        // ...
    });
    // ...
}

function eliminarProducto(index) {
    shoppingCart.splice(index, 1); // Eliminar el producto del carrito por su índice
    actualizarListaCompra(); // Actualizar la lista de compra después de eliminar el producto
}
  // Resto del código JavaScript (sin cambios)...
  // ...

</script>

  </script>
  <script>
    let products = []; // Declaramos la variable products a nivel global.
    let shoppingCart = []; // Declaramos la variable shoppingCart a nivel global.
    let totalAmount = 0; // Inicializamos el total del monto a pagar en 0.

    // Resto del código JavaScript (sin cambios)...
    // ...



    function agregarProductoPorCodigoBarras() {
      const manualProductBarcode = Number(document.getElementById("manualProductBarcode").value);
      const selectedProduct = products.find(product => Number(product.codigo_barras) === manualProductBarcode);
      if (selectedProduct) {
        agregarProducto(selectedProduct);
      } else {
        alert("Producto no encontrado en la base de datos.");
      }
    }

    function mostrarResultados(data) {
      products = data;
      const productList = document.getElementById("productList");
      productList.innerHTML = "";

      products.forEach(product => {
        const listItem = document.createElement("li");
        listItem.textContent = `${product.nombre} - Precio: $${product.precio} `;

        const addButton = document.createElement("button");
        addButton.textContent = "Agregar al Carrito";
        addButton.setAttribute("data-product-codigo", product.codigo_barras); // Asegúrate de que este atributo esté configurado.
        addButton.addEventListener("click", () => agregarProducto(product));

        listItem.appendChild(addButton);
        productList.appendChild(listItem);
      });
    }


    function agregarProducto(product) {
      shoppingCart.push(product);
      actualizarListaCompra();
    }

    function eliminarProducto(index) {
      shoppingCart.splice(index, 1);
      actualizarListaCompra();
    }



    // Resto del código JavaScript (sin cambios)...
    // ...
  </script>
{% endblock %}
