{% extends 'core/base.html' %}
{% load static %}
{% block contenido %}
<title>Ventas con Búsqueda de Productos</title>

<body>
  <h1>Ventas con Búsqueda de Productos</h1>
  <div>
    <label for="productSearch">Buscar Producto por Nombre:</label>
    <input type="text" id="productSearch" oninput="buscarProductos()">
  </div>

  <h2>Resultados de la Búsqueda</h2>
  <ul id="productList"></ul>

  <div>
    <label for="manualProductBarcode">Código de Barras:</label>
    <input type="text" id="manualProductBarcode">
    <button type="button" onclick="agregarProductoPorCodigoBarras()">Agregar Producto</button>
  </div>

  <h2>Lista de Compra</h2>
  <ul id="shoppingList"></ul>

  <div>
    <p>Total a Pagar: $<span id="totalAmount">0</span></p>
    <button type="button" onclick="pagar()">Pagar</button>
    <div id="metodoPagoContainer" style="display: none;">
      <label for="metodoPago">Método de Pago:</label>
      <select id="metodoPago">
        <option value="efectivo">Efectivo</option>
        <option value="tarjeta_credito">Tarjeta de Crédito</option>
        <option value="tarjeta_debito">Tarjeta de Débito</option>
        <option value="prepago">Prepago</option>
      </select>
      <br>
      <label for="montoPagado">Monto Pagado:</label>
      <input type="number" id="montoPagado" min="0" step="0.01">
      <br>
      <label for="vuelto">Vuelto:</label>
      <input type="number" id="vuelto" disabled>
      <br>
      <label for="ivaPagado">IVA Pagado:</label>
      <input type="number" id="ivaPagado" disabled>
      <br>
    </div>
  </div>
    <a href="{% url 'generar_boleta' %}" target="_blank">
      <button type="button">Imprimir Boleta</button>
    </a>
  </div>
  <script>
    // Resto del código JavaScript (sin cambios)...
    // ...

    function pagar() {
      // Mostrar el formulario de método de pago
      const metodoPagoContainer = document.getElementById("metodoPagoContainer");
      metodoPagoContainer.style.display = "block";

      // Obtener el método de pago seleccionado
      const metodoPago = document.getElementById("metodoPago").value;

      // Obtener el monto pagado por el cliente
      const montoPagado = parseFloat(document.getElementById("montoPagado").value);

      // Calcular el vuelto y el IVA pagado
      const vuelto = montoPagado - totalAmount;
      const ivaPagado = totalAmount * 0.19;

      // Mostrar el vuelto y el IVA pagado
      document.getElementById("vuelto").value = vuelto.toFixed(2);
      document.getElementById("ivaPagado").value = ivaPagado.toFixed(2);

      // Aquí podrías implementar la lógica para procesar el pago y guardar la venta en la base de datos.
      alert(`Total a Pagar: $${totalAmount.toFixed(2)}\nMétodo de Pago: ${metodoPago}\nMonto Pagado: $${montoPagado.toFixed(2)}\nVuelto: $${vuelto.toFixed(2)}\nIVA Pagado: $${ivaPagado.toFixed(2)}\n¡Gracias por su compra!`);

      shoppingCart = [];
      actualizarListaCompra();
    }
  </script>
  <script>
    function buscarProductos() {
      const searchTerm = document.getElementById("productSearch").value.toLowerCase();

      // Realizar la solicitud AJAX a la URL de Django
      fetch(`/buscar-producto-ajax/?search_input=${searchTerm}`)
        .then(response => response.json())
        .then(data => mostrarResultados(data))
        .catch(error => console.error("Error en la solicitud AJAX:", error));
    }

    function mostrarResultados(products) {
      const productList = document.getElementById("productList");
      productList.innerHTML = ""; // Limpiamos la lista antes de mostrar los resultados.

      products.forEach(product => {
        const listItem = document.createElement("li");
        listItem.textContent = `${product.nombre} - Precio: $${product.precio} - Descuento: ${product.descuento}%`;
        listItem.setAttribute("data-product-id", product.id);
        listItem.addEventListener("click", agregarProductoPorNombre);
        productList.appendChild(listItem);
      });
    }

    function agregarProductoPorNombre(event) {
      const productId = event.target.getAttribute("data-product-id");
      const selectedProduct = products.find(product => product.id === productId);
      agregarProducto(selectedProduct);
    }

    function agregarProductoPorCodigoBarras() {
      const manualProductBarcode = document.getElementById("manualProductBarcode").value;
      const selectedProduct = products.find(product => product.id === manualProductBarcode);
      if (selectedProduct) {
        agregarProducto(selectedProduct);
      } else {
        alert("Producto no encontrado en la base de datos.");
      }
    }

    function agregarProducto(product) {
      shoppingCart.push(product);
      actualizarListaCompra();
    }

    function eliminarProducto(index) {
      shoppingCart.splice(index, 1);
      actualizarListaCompra();
    }

    function actualizarListaCompra() {
      const shoppingList = document.getElementById("shoppingList");
      shoppingList.innerHTML = "";

      totalAmount = 0.00;
      shoppingCart.forEach((product, index) => {
        const listItem = document.createElement("li");
        listItem.textContent = `${product.nombre} - Precio: $${product.precio.toFixed(2)} - Descuento: ${product.descuento}%`;
        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Eliminar";
        deleteButton.addEventListener("click", () => eliminarProducto(index));
        listItem.appendChild(deleteButton);
        shoppingList.appendChild(listItem);

        totalAmount += product.precio * (1 - product.descuento / 100);
      });

      document.getElementById("totalAmount").textContent = totalAmount.toFixed(2);
    }

    function pagar() {
      // Aquí podrías implementar la lógica para procesar el pago y guardar la venta en la base de datos.
      alert(`Total a Pagar: $${totalAmount.toFixed(2)}. ¡Gracias por su compra!`);
      shoppingCart = [];
      actualizarListaCompra();
    }
  </script>
 <script>
  let products = []; // Declaramos la variable products a nivel global.
  
  // Resto del código JavaScript (sin cambios)...
  // ...

  function mostrarResultados(data) {
    products = data; // Actualizamos la variable products con los datos recibidos.
    const productList = document.getElementById("productList");
    productList.innerHTML = ""; // Limpiamos la lista antes de mostrar los resultados.

    products.forEach(product => {
      const listItem = document.createElement("li");
      listItem.textContent = `${product.nombre} - Precio: $${product.precio} - Descuento: ${product.descuento}%`;
      listItem.setAttribute("data-product-id", product.id);
      listItem.addEventListener("click", agregarProductoPorNombre);
      productList.appendChild(listItem);
    });
  }

  function agregarProductoPorNombre(event) {
    const productId = event.target.getAttribute("data-product-id");
    const selectedProduct = shoppingCart.find(product => product.id === productId); // Buscamos el producto en el carrito.
    agregarProducto(selectedProduct);
  }

  function agregarProductoPorCodigoBarras(event) {
    const productCodigo = event.target.getAttribute("data-product-codigo");
    const selectedProduct = products.find(product => product.codigo_barras === productCodigo); // Buscamos el producto por su codigo de barras.
    if (selectedProduct) {
      agregarProducto(selectedProduct);
    } else {
      alert("Producto no encontrado en el carrito.");
    }
  }

  // Resto del código JavaScript (sin cambios)...
  // ...
</script>


  {% endblock %}